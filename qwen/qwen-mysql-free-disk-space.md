# æˆ‘æœ‰ä¸€ä¸ªmysqlæ•°æ®åº“ï¼Œéšç€æ•°æ®å¢å¤šï¼Œå ç”¨äº†è¶Šæ¥è¶Šå¤šçš„ç£ç›˜ç©ºé—´ï¼Œæˆ‘åˆ é™¤äº†å¾ˆå¤šè¿‡æœŸçš„æ•°æ®ï¼Œä½†ç£ç›˜ç©ºé—´å¹¶æ²¡å¾—åˆ°é‡Šæ”¾ï¼Œæˆ‘è¯¥å¦‚ä½•åšæ‰èƒ½å›æ”¶ç£ç›˜ç©ºé—´ï¼Ÿ

åœ¨ MySQL ä¸­ï¼Œå³ä½¿ä½ ä½¿ç”¨ `DELETE` è¯­å¥åˆ é™¤äº†å¤§é‡æ•°æ®ï¼Œç£ç›˜ç©ºé—´**ä¸ä¸€å®šç«‹å³é‡Šæ”¾**ã€‚è¿™æ˜¯å› ä¸º MySQL çš„å­˜å‚¨å¼•æ“ï¼ˆå°¤å…¶æ˜¯ InnoDBï¼‰åœ¨åˆ é™¤æ•°æ®æ—¶å¹¶ä¸ä¼šè‡ªåŠ¨æ”¶ç¼©æ•°æ®æ–‡ä»¶ï¼ˆ`.ibd` æ–‡ä»¶æˆ–å…±äº«è¡¨ç©ºé—´ `ibdata1`ï¼‰ã€‚ä»¥ä¸‹æ˜¯å‡ ç§æœ‰æ•ˆçš„æ–¹æ³•æ¥**çœŸæ­£å›æ”¶ç£ç›˜ç©ºé—´**ï¼š

---

### âœ… 1. ä½¿ç”¨ `OPTIMIZE TABLE`ï¼ˆæ¨èç”¨äº InnoDB è¡¨ï¼‰
`OPTIMIZE TABLE` ä¼šé‡å»ºè¡¨å¹¶é‡Šæ”¾æœªä½¿ç”¨çš„ç©ºé—´ã€‚

```sql
OPTIMIZE TABLE your_table_name;
```

**æ•ˆæœï¼š**
- é‡å»ºè¡¨å¹¶æ•´ç†ç¢ç‰‡ã€‚
- é‡Šæ”¾æœªä½¿ç”¨çš„ç©ºé—´å›æ“ä½œç³»ç»Ÿï¼ˆå¯¹ç‹¬ç«‹è¡¨ç©ºé—´æœ‰æ•ˆï¼‰ã€‚
- å¯¹ InnoDB å¼•æ“æœ‰æ•ˆï¼ˆå‰ææ˜¯ `innodb_file_per_table = ON`ï¼‰ã€‚

> âš ï¸ æ³¨æ„ï¼š`OPTIMIZE TABLE` ä¼šé”è¡¨ï¼Œå»ºè®®åœ¨ä½å³°æœŸæ‰§è¡Œã€‚

---

### âœ… 2. ç¡®è®¤ `innodb_file_per_table` æ˜¯å¦å¼€å¯ï¼ˆå…³é”®ï¼ï¼‰

æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†ç‹¬ç«‹è¡¨ç©ºé—´ï¼š

```sql
SHOW VARIABLES LIKE 'innodb_file_per_table';
```

- å¦‚æœå€¼ä¸º `ON`ï¼šæ¯ä¸ªè¡¨çš„æ•°æ®å­˜å‚¨åœ¨ç‹¬ç«‹çš„ `.ibd` æ–‡ä»¶ä¸­ï¼Œ**åˆ é™¤æ•°æ®åå¯é€šè¿‡ `OPTIMIZE TABLE` é‡Šæ”¾ç©ºé—´ç»™æ“ä½œç³»ç»Ÿ**ã€‚
- å¦‚æœå€¼ä¸º `OFF`ï¼šæ‰€æœ‰è¡¨å…±äº« `ibdata1` æ–‡ä»¶ï¼Œ**å³ä½¿åˆ é™¤æ•°æ®ä¹Ÿæ— æ³•é‡Šæ”¾ç©ºé—´**ã€‚

#### ğŸ”§ å¦‚ä½•å¼€å¯ï¼ˆå¦‚æœå°šæœªå¼€å¯ï¼‰ï¼š
åœ¨ `my.cnf` æˆ– `my.ini` é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```ini
[mysqld]
innodb_file_per_table = ON
```

> âš ï¸ ä¿®æ”¹ååªå¯¹**æ–°åˆ›å»ºçš„è¡¨**ç”Ÿæ•ˆï¼Œå·²æœ‰è¡¨ä»ä½¿ç”¨å…±äº«è¡¨ç©ºé—´ã€‚

---

### âœ… 3. é‡å»ºè¡¨ï¼ˆæ›¿ä»£ OPTIMIZE TABLEï¼‰
å¦‚æœä½ ä¸èƒ½ä½¿ç”¨ `OPTIMIZE TABLE`ï¼ˆå¦‚é”è¡¨æ—¶é—´å¤ªé•¿ï¼‰ï¼Œå¯ä»¥ç”¨ï¼š

```sql
ALTER TABLE your_table_name ENGINE=InnoDB;
```

æ•ˆæœä¸ `OPTIMIZE TABLE` ç±»ä¼¼ï¼Œä¼šé‡å»ºè¡¨å¹¶é‡Šæ”¾ç©ºé—´ã€‚

---

### âœ… 4. å¯¹äºå¤§è¡¨ï¼šä½¿ç”¨ `pt-online-schema-change`ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰

ä½¿ç”¨ Percona Toolkit çš„ `pt-online-schema-change` å·¥å…·å¯ä»¥åœ¨ä¸é”è¡¨çš„æƒ…å†µä¸‹é‡å»ºè¡¨ï¼Œé¿å…æœåŠ¡ä¸­æ–­ã€‚

ç¤ºä¾‹ï¼š
```bash
pt-online-schema-change --alter "ENGINE=InnoDB" D=your_db,t=your_table --execute
```

---

### âœ… 5. åˆ é™¤æ•´ä¸ªè¡¨åé‡å»ºï¼ˆæç«¯æƒ…å†µï¼‰
å¦‚æœä½ åˆ é™¤äº†å‡ ä¹å…¨éƒ¨æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘ï¼š

```sql
RENAME TABLE old_table TO old_table_backup;
-- é‡æ–°åˆ›å»ºè¡¨ç»“æ„
CREATE TABLE old_table (...);
-- å¯¼å…¥å‰©ä½™æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰
INSERT INTO old_table SELECT * FROM old_table_backup WHERE ...;
-- åˆ é™¤å¤‡ä»½è¡¨
DROP TABLE old_table_backup;
```

è¿™èƒ½å½»åº•é‡Šæ”¾ç©ºé—´ã€‚

---

### âŒ ä¸ºä»€ä¹ˆ `DELETE` ä¸é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Ÿ
- `DELETE` åªæ˜¯æ ‡è®°æ•°æ®ä¸ºâ€œå¯è¦†ç›–â€ï¼Œç©ºé—´ä»è¢« InnoDB ä¿ç•™ç”¨äºåç»­æ’å…¥ã€‚
- æ•°æ®é¡µä¸­çš„ç¢ç‰‡ä¸ä¼šè‡ªåŠ¨æ•´ç†ã€‚
- å…±äº«è¡¨ç©ºé—´ï¼ˆ`ibdata1`ï¼‰æ°¸è¿œä¸ä¼šç¼©å°ã€‚

---

### âœ… 6. æ¸…ç†äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆbinlogï¼‰â€”â€”é¢å¤–ç©ºé—´ä¼˜åŒ–
å¦‚æœä½ å¯ç”¨äº† binlogï¼Œæ—§æ—¥å¿—å¯èƒ½å ç”¨å¤§é‡ç©ºé—´ã€‚

æŸ¥çœ‹ binlog æ–‡ä»¶ï¼š

```sql
SHOW BINARY LOGS;
```

æ¸…ç†è¿‡æœŸæ—¥å¿—ï¼ˆä¾‹å¦‚ä¿ç•™æœ€è¿‘7å¤©ï¼‰ï¼š

```sql
PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);
```

æˆ–åœ¨é…ç½®ä¸­è®¾ç½®è‡ªåŠ¨æ¸…ç†ï¼š

```ini
expire_logs_days = 7
```

> æ³¨æ„ï¼šMySQL 8.0+ ä½¿ç”¨ `binlog_expire_logs_seconds`ã€‚

---

### âœ… æ€»ç»“ï¼šå›æ”¶ç©ºé—´çš„æ¨èæ­¥éª¤

1. ç¡®è®¤ `innodb_file_per_table = ON`
2. å¯¹å¤§è¡¨æ‰§è¡Œ `OPTIMIZE TABLE` æˆ– `ALTER TABLE ... ENGINE=InnoDB`
3. æ¸…ç†ä¸å¿…è¦çš„ binlog
4. ç›‘æ§ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š`du -h /var/lib/mysql/`

---

### ğŸ” éªŒè¯ç©ºé—´æ˜¯å¦é‡Šæ”¾
æŸ¥çœ‹è¡¨çš„ç£ç›˜ä½¿ç”¨æƒ…å†µï¼š

```sql
SELECT 
    table_name,
    round(((data_length + index_length) / 1024 / 1024), 2) `Size (MB)`
FROM information_schema.tables
WHERE table_schema = 'your_database_name'
ORDER BY (data_length + index_length) DESC;
```

åŒæ—¶ç”¨ç³»ç»Ÿå‘½ä»¤æŸ¥çœ‹æ–‡ä»¶å¤§å°å˜åŒ–ï¼š

```bash
du -h /var/lib/mysql/your_database/
```

---

å¦‚æœä½ æä¾›å…·ä½“çš„è¡¨ç»“æ„ã€å¼•æ“ç±»å‹å’Œ MySQL ç‰ˆæœ¬ï¼Œæˆ‘å¯ä»¥ç»™å‡ºæ›´ç²¾ç¡®çš„å»ºè®®ã€‚
